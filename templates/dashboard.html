{% extends 'base.html' %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<link rel="stylesheet" href="/static/css/dashboard.css">
<div class="home">
    <div class="title-bar">
        <h2>Welcome, {{user['username']}} <span class="badge">Pro</span></h2>
    </div>
    
    <!-- Activity Heatmap -->
    <div class="heatmap-container">

        
        <div class="heatmap-wrapper">
            <div class="heatmap-container-inner">
                <!-- Month labels -->
                <div class="heatmap-months">
                    {% for month in heatmap_data.months %}
                    <div class="month-label">{{ month.name }}</div>
                    {% endfor %}
                </div>
                
                <!-- Heatmap grid -->
                <div class="heatmap-grid">
                    <!-- Day labels column -->
                    <div class="heatmap-days-column">
                        <div class="day-label">Mon</div>
                        <div class="day-label">Tue</div>
                        <div class="day-label">Wed</div>
                        <div class="day-label">Thu</div>
                        <div class="day-label">Fri</div>
                        <div class="day-label">Sat</div>
                        <div class="day-label">Sun</div>
                    </div>
                    
                    <!-- Activity weeks -->
                    <div class="heatmap-weeks">
                        {% for week in heatmap_data.weeks %}
                        <div class="heatmap-week">
                            {% for day in week %}
                            <div class="heatmap-day level-{{ day.level }}" 
                                 data-date="{{ day.date }}" 
                                 data-count="{{ day.count }}">
                            </div>
                            {% endfor %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Legend -->
                <div class="heatmap-legend">
                    <span class="legend-text">Less</span>
                    <div class="legend-squares">
                        <div class="legend-item level-0" title="No activity"></div>
                        <div class="legend-item level-1" title="1-2 activities"></div>
                        <div class="legend-item level-2" title="3-5 activities"></div>
                        <div class="legend-item level-3" title="6-10 activities"></div>
                        <div class="legend-item level-4" title="11+ activities"></div>
                    </div>
                    <span class="legend-text">More</span>
                </div>
            </div>
        </div>

        <div class="heatmap-header">
            <div class="day-progress-container">
                <div class="day-progress-circle" id="dayProgress">
                    <div class="day-progress-inner">
                        <div class="streak-number">{{ heatmap_data.current_streak or 0 }}</div>
                        <div id="not-extended">
                            <div class="day-progress-time" id="progressTime">--:--</div>
                            <div class="day-progress-label">remaining</div>
                        </div>
                        <div id="extended">
                            <i>Extended</i>
                        </div>
                    </div>
                </div>
                <button class="extend">Extend</button>
            </div>
        </div>
    </div>

    <div class="activity">
        <h3 class="section-title"><i class="fas fa-chart-line"></i> Recent Activity</h3>
        {% if activity and activity|length > 0 %}
            <!-- Update the activity item section in the main activity list -->
            <div class="activity-list">
                {% for item in activity[:5] %}
                    <div class="activity-item">
                        {% if item.action == "test_created" %}
                            <div class="activity-icon"><i class="fas fa-plus-circle"></i></div>
                        {% elif item.action == "test_completed" %}
                            <div class="activity-icon"><i class="fas fa-check-circle"></i></div>
                        {% elif item.action == "test_started" %}
                            <div class="activity-icon"><i class="fas fa-play-circle"></i></div>
                        {% elif item.action == "attempt_question" %}
                            <div class="activity-icon {% if item.details.is_correct %}correct{% else %}incorrect{% endif %}">
                                {% if item.details.is_correct %}
                                <i class="fas fa-check"></i>
                                {% else %}
                                <i class="fas fa-times"></i>
                                {% endif %}
                            </div>
                        {% elif item.action == "daily_task_completed" %}
                            <div class="activity-icon {% if item.details.is_success %}correct{% else %}incorrect{% endif %}">
                                {% if item.details.is_success %}
                                <i class="fas fa-fire"></i>
                                {% else %}
                                <i class="fas fa-heart-broken"></i>
                                {% endif %}
                            </div>
                        {% else %}
                            <div class="activity-icon"><i class="fas fa-bell"></i></div>
                        {% endif %}
                        <div class="activity-content">
                            <div class="activity-header">
                                {% if item.action == "test_created" %}
                                    <span>Created a new test: <strong>{{ item.details.title }}</strong></span>
                                {% elif item.action == "test_completed" %}
                                    <div class="activity-header-content">
                                        <span>Completed test: <strong>{{ item.details.title }}</strong></span>
                                        <div class="activity-score">
                                            {{ item.details.score }}
                                        </div>
                                    </div>
                                {% elif item.action == "test_started" %}
                                    <span>Started test: <strong>{{ item.details.title }}</strong></span>
                                {% elif item.action == "attempt_question" %}
                                    Attempted a question 
                                    <div class="{% if item.details.is_correct %}answer-correct{% else %}answer-incorrect{% endif %}">
                                        {% if item.details.is_correct %}
                                            <i class="fas fa-check-circle"></i> Correct
                                        {% else %}
                                            <i class="fas fa-times-circle"></i> Incorrect
                                        {% endif %}
                                    </div>
                                {% elif item.action == "daily_task_completed" %}
                                    <div class="activity-header-content">
                                        <span>Completed daily task</span>
                                        <div class="daily-task-stats">
                                            {% if item.details.is_success %}
                                                <div class="daily-task-badge success">
                                                    <i class="fas fa-fire"></i> Streak Extended
                                                </div>
                                            {% else %}
                                                <div class="daily-task-badge failed">
                                                    <i class="fas fa-heart-broken"></i> Streak Broken
                                                </div>
                                            {% endif %}
                                            
                                            <!-- Health Badge - simplified display -->
                                            <div class="health-badge {% if item.details.health_remaining > 70 %}high{% elif item.details.health_remaining > 30 %}medium{% else %}low{% endif %}">
                                                <i class="fas fa-heart"></i> {{ item.details.health_remaining|round|int }}%
                                            </div>
                                        </div>
                                    </div>
                                {% else %}
                                    {{ item.action }}
                                {% endif %}
                            </div>
                            <div class="activity-time">
                                <i class="far fa-clock"></i> {{ item.timestamp|formatdatetime }}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            {% if activity|length > 5 %}
            <div class="view-all-container">
                <button id="view-all-activity" class="view-all-btn">
                    <i class="fas fa-history"></i> View All Activities
                </button>
            </div>
            {% endif %}
        {% else %}
            <div class="empty-state">
                <div class="empty-icon"><i class="fas fa-history"></i></div>
                <p>No recent activity to show. Start solving problems to see your progress here!</p>
            </div>
        {% endif %}
    </div>
    
    <div class="tests">
        <h3 class="section-title"><i class="fas fa-tasks"></i> My Tests</h3>
        {% if tests and tests|length > 0 %}
            <div class="tests-list">
                {% for test in tests[:2] %}
                    <div class="test-item">
                        <div class="test-item-header">
                            <h4 class="test-title">{{ test.title }}</h4>
                            {% if test.mode == "generate" %}
                                <div class="test-badge custom">
                                    <i class="fas fa-magic"></i> Custom
                                </div>
                            {% elif test.mode == "previous" %}
                                <div class="test-badge previous">
                                    <i class="fas fa-history"></i> PYQ
                                </div>
                            {% endif %}
                        </div>
                        <div class="test-item-body">
                            <div class="test-meta">
                                <div class="test-date"><i class="far fa-calendar-alt"></i> {{ test.created_at|formatdate }}</div>
                                <div class="test-duration"><i class="far fa-clock"></i> {{ test.duration }} min</div>
                            </div>
                            {% if test.attempts and test.attempts|length > 0 %}
                                <div class="test-attempts">
                                    <div class="attempt-count">
                                        <i class="fas fa-check-double"></i> {{ test.attempts|length }} attempt{{ 's' if test.attempts|length > 1 else '' }}
                                    </div>
                                    <div class="score-pill {{ 'high-score' if (test.attempts[0].score / test.max_marks * 100) >= 70 
                                                            else 'mid-score' if (test.attempts[0].score / test.max_marks * 100) >= 40 
                                                            else 'low-score' }}">
                                        {{ test.attempts[0].score }}
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                        <div class="test-item-footer">
                            <div class="test-actions">
                                <a href="/test/{{ test._id }}" class="test-action-btn">
                                    {% if test.attempts and test.attempts|length > 0 %}
                                        <i class="fas fa-redo"></i> Retry
                                    {% else %}
                                        <i class="fas fa-play"></i> Start
                                    {% endif %}
                                </a>
                                {% if test.attempts and test.attempts|length > 0 %}
                                <a href="/test/{{ test._id }}/analysis" class="test-action-btn analysis">
                                    <i class="fas fa-chart-bar"></i> Analysis
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            {% if tests|length > 2 %}
            <div class="view-all-container">
                <button id="view-all-tests" class="view-all-btn">
                    <i class="fas fa-clipboard-list"></i> View All Tests
                </button>
            </div>
            {% endif %}
        {% else %}
            <div class="empty-state">
                <div class="empty-icon"><i class="fas fa-clipboard-list"></i></div>
                <p>You haven't created any tests yet. Generate your first personalized test below!</p>
            </div>
        {% endif %}
    </div>
    
    <div class="actions">
        <a href="/search" class="action-btn">
            <i class="fas fa-search"></i>
            <h5 class="action-title">Search 47k+ Questions</h5>
        </a>
        <a href="/test/generate" class="action-btn">
            <i class="fas fa-clipboard-list"></i>
            <h5 class="action-title">Generate Personalized Tests</h5>
        </a>
        <a href="/ai" class="action-btn">
            <i class="fas fa-robot"></i>
            <h5 class="action-title">Ask Doubts to PlanqAI</h5>
        </a>
    </div>
</div>

<!-- Tooltip for heatmap -->
<div id="heatmap-tooltip" class="heatmap-tooltip"></div>

<!-- Activity Modal -->
<div id="activity-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-chart-line"></i> All Activities</h3>
            <span class="modal-close">&times;</span>
        </div>
        <div class="modal-body">
            {% if activity and activity|length > 0 %}
                <div class="activity-list-full">
                    {% for item in activity %}
                        <div class="activity-item">
                            {% if item.action == "test_created" %}
                                <div class="activity-icon"><i class="fas fa-plus-circle"></i></div>
                            {% elif item.action == "test_completed" %}
                                <div class="activity-icon"><i class="fas fa-check-circle"></i></div>
                            {% elif item.action == "test_started" %}
                                <div class="activity-icon"><i class="fas fa-play-circle"></i></div>
                            {% elif item.action == "attempt_question" %}
                                <div class="activity-icon {% if item.details.is_correct %}correct{% else %}incorrect{% endif %}">
                                    {% if item.details.is_correct %}
                                    <i class="fas fa-check"></i>
                                    {% else %}
                                    <i class="fas fa-times"></i>
                                    {% endif %}
                                </div>
                            {% elif item.action == "daily_task_completed" %}
                                <div class="activity-icon {% if item.details.is_success %}correct{% else %}incorrect{% endif %}">
                                    {% if item.details.is_success %}
                                    <i class="fas fa-fire"></i>
                                    {% else %}
                                    <i class="fas fa-heart-broken"></i>
                                    {% endif %}
                                </div>
                            {% else %}
                                <div class="activity-icon"><i class="fas fa-bell"></i></div>
                            {% endif %}
                            <div class="activity-content">
                                <div class="activity-header">
                                    {% if item.action == "test_created" %}
                                        Created a new test:&nbsp; <strong>{{ item.details.title }}</strong>
                                    {% elif item.action == "test_completed" %}
                                        Completed test:&nbsp; <strong>{{ item.details.title }}</strong>
                                        <div class="activity-score">
                                            {{ item.details.score }}
                                        </div>
                                    {% elif item.action == "test_started" %}
                                        Started test:&nbsp; <strong>{{ item.details.title }}</strong>
                                    {% elif item.action == "attempt_question" %}
                                        Attempted a question 
                                        <div class="{% if item.details.is_correct %}answer-correct{% else %}answer-incorrect{% endif %}">
                                            {% if item.details.is_correct %}
                                                <i class="fas fa-check-circle"></i> Correct
                                            {% else %}
                                                <i class="fas fa-times-circle"></i> Incorrect
                                            {% endif %}
                                        </div>
                                    {% elif item.action == "daily_task_completed" %}
                                    <div class="activity-header-content">
                                        <span>Completed daily task</span>
                                        <div class="daily-task-stats">
                                            {% if item.details.is_success %}
                                                <div class="daily-task-badge success">
                                                    <i class="fas fa-fire"></i> Streak Extended
                                                </div>
                                            {% else %}
                                                <div class="daily-task-badge failed">
                                                    <i class="fas fa-heart-broken"></i> Streak Broken
                                                </div>
                                            {% endif %}
                                            
                                            <!-- Health Badge - simplified display -->
                                            <div class="health-badge {% if item.details.health_remaining > 70 %}high{% elif item.details.health_remaining > 30 %}medium{% else %}low{% endif %}">
                                                <i class="fas fa-heart"></i> {{ item.details.health_remaining|round|int }}%
                                            </div>
                                        </div>
                                    </div>
                                    {% else %}
                                        {{ item.action }}
                                    {% endif %}
                                </div>
                                <div class="activity-time">
                                    <i class="far fa-clock"></i> {{ item.timestamp|formatdatetime }}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <p>No activity to show.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Tests Modal -->
<div id="tests-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-tasks"></i> All Tests</h3>
            <span class="modal-close">&times;</span>
        </div>
        <div class="modal-body">
            {% if tests and tests|length > 0 %}
                <div class="tests-grid-full">
                    {% for test in tests %}
                        <div class="test-item">
                            <div class="test-item-header">
                                <h4 class="test-title">{{ test.title }}</h4>
                                {% if test.mode == "generate" %}
                                    <div class="test-badge custom">
                                        <i class="fas fa-magic"></i> Custom
                                    </div>
                                {% elif test.mode == "previous" %}
                                    <div class="test-badge previous">
                                        <i class="fas fa-history"></i> PYQ
                                    </div>
                                {% endif %}
                            </div>
                            <div class="test-item-body">
                                <div class="test-meta">
                                    <div class="test-date"><i class="far fa-calendar-alt"></i> {{ test.created_at|formatdate }}</div>
                                    <div class="test-duration"><i class="far fa-clock"></i> {{ test.duration }} min</div>
                                </div>
                                {% if test.attempts and test.attempts|length > 0 %}
                                    <div class="test-attempts">
                                        <div class="attempt-count">
                                            <i class="fas fa-check-double"></i> {{ test.attempts|length }} attempt{{ 's' if test.attempts|length > 1 else '' }}
                                        </div>
                                        <div class="score-pill {{ 'high-score' if (test.attempts[0].score / test.max_marks * 100) >= 70 
                                                                else 'mid-score' if (test.attempts[0].score / test.max_marks * 100) >= 40 
                                                                else 'low-score' }}">
                                            {{ test.attempts[0].score }}
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="test-no-attempts">
                                        <i class="far fa-hourglass"></i> Not attempted yet
                                    </div>
                                {% endif %}
                            </div>
                            <div class="test-item-footer">
                                <div class="test-actions">
                                    <a href="/test/{{ test._id }}" class="test-action-btn">
                                        {% if test.attempts and test.attempts|length > 0 %}
                                            <i class="fas fa-redo"></i> Retry
                                        {% else %}
                                            <i class="fas fa-play"></i> Start
                                        {% endif %}
                                    </a>
                                    <a href="/test/{{ test._id }}/analysis" class="test-action-btn analysis {{ 'disabled' if not test.attempts or test.attempts|length == 0 }}">
                                        <i class="fas fa-chart-bar"></i> Analysis
                                    </a>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <p>You haven't created any tests yet.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add this modal after your existing modals -->
<div id="extend-streak-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-calendar-plus"></i> Daily Task</h3>
            <span class="modal-close">&times;</span>
        </div>
        <div class="modal-body">
            <div class="daily-task-form">
                <div class="filter-section">
                    <div class="filters-container">
                        <div class="filter-group">
                            <label>Exam:</label>
                            <select id="examFilter" class="form-select">
                                <option value="">Select Exam</option>
                                {% for exam in exams %}
                                <option value="{{ exam._id }}">{{ exam.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>Subject:</label>
                            <select id="subjectFilter" class="form-select" disabled>
                                <option value="">Select Subject</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>Chapter:</label>
                            <select id="chapterFilter" class="form-select" disabled>
                                <option value="">Select Chapter</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="daily-task-options">
                    <div class="option-group">
                        <label>Questions:</label>
                        <div class="number-input">
                            <button type="button" onclick="this.parentNode.querySelector('input[type=number]').stepDown()">-</button>
                            <input type="number" min="5" max="30" value="5" id="questionCount">
                            <button type="button" onclick="this.parentNode.querySelector('input[type=number]').stepUp()">+</button>
                        </div>
                    </div>
                    
                    <div class="option-group">
                        <label>Time (minutes):</label>
                        <div class="number-input">
                            <button type="button" onclick="this.parentNode.querySelector('input[type=number]').stepDown()">-</button>
                            <input type="number" min="5" max="120" value="30" id="timeLimit">
                            <button type="button" onclick="this.parentNode.querySelector('input[type=number]').stepUp()">+</button>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button id="startDailyTask" class="btn btn-primary">Start</button>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="/static/js/dashboard.js"></script>
{% endblock %}