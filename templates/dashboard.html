{% extends 'base.html' %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<link rel="stylesheet" href="/static/css/dashboard.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<div class="home">
    <div class="profile-info title-bar">
            <div class="profile-details-main">
                <h4 class="profile-username"><span class="muted">Welcome,</span> <br>{{ user.username }}</h4>
            </div>
            {% if user.xp_info %}
            <div class="xp-container">
                <div class="xp-level-progress">
                    <svg class="xp-ring" width="80" height="80">
                        <circle class="xp-ring-bg" stroke-width="8" fill="transparent" r="36" cx="40" cy="40"/>
                        <circle class="xp-ring-fg" stroke-width="8" fill="transparent" r="36" cx="40" cy="40"
                                style="stroke-dasharray: {{ 2 * 3.14159 * 36 }}; stroke-dashoffset: {{ 2 * 3.14159 * 36 * (1 - user.xp_info.progress / 100) }};"/>
                    </svg>
                    <div class="xp-level-text">
                        <div class="level-label">Level</div>
                        <div class="level-number">{{ user.xp_info.level }}</div>
                    </div>
                </div>
                <div class="xp-details">
                    <div class="xp-total">
                        <i class="fas fa-star"></i>
                        <span>{{ user.xp_info.total_xp|int }} XP</span>
                    </div>
                    <div class="xp-bar-container">
                        <div class="xp-bar">
                            <div class="xp-fill" style="width: {{ user.xp_info.progress }}%;"></div>
                        </div>
                        <div class="xp-progress-text">
                            <span>{{ user.xp_info.xp_current|int }} / {{ user.xp_info.xp_needed|int }} XP to next level</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    <!-- Activity Heatmap -->
    <div class="heatmap-container">
        <div class="heatmap-wrapper">
            <div class="heatmap-container-inner">
                <!-- Month labels -->
                <div class="heatmap-months">
                    {% for month in heatmap_data.months %}
                    <div class="month-label">{{ month.name }}</div>
                    {% endfor %}
                </div>
                
                <!-- Heatmap grid -->
                <div class="heatmap-grid">
                    <!-- Day labels column -->
                    <div class="heatmap-days-column">
                        <div class="day-label">Mon</div>
                        <div class="day-label">Tue</div>
                        <div class="day-label">Wed</div>
                        <div class="day-label">Thu</div>
                        <div class="day-label">Fri</div>
                        <div class="day-label">Sat</div>
                        <div class="day-label">Sun</div>
                    </div>
                    
                    <!-- Activity weeks -->
                    <div class="heatmap-weeks">
                        {% for week in heatmap_data.weeks %}
                        <div class="heatmap-week">
                            {% for day in week %}
                            <div class="heatmap-day level-{{ day.level }}" 
                                 data-date="{{ day.date }}" 
                                 data-count="{{ day.count }}">
                            </div>
                            {% endfor %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Legend -->
                <div class="heatmap-legend">
                    <span class="legend-text">Less</span>
                    <div class="legend-squares">
                        <div class="legend-item level-0" title="No activity"></div>
                        <div class="legend-item level-1" title="1-2 activities"></div>
                        <div class="legend-item level-2" title="3-5 activities"></div>
                        <div class="legend-item level-3" title="6-10 activities"></div>
                        <div class="legend-item level-4" title="11+ activities"></div>
                    </div>
                    <span class="legend-text">More</span>
                </div>
            </div>
        </div>

        <div class="heatmap-header">
            <div class="day-progress-container">
                <div class="day-progress-circle" id="dayProgress">
                    <div class="day-progress-inner">
                        <div class="streak-number">{{ heatmap_data.current_streak or 0 }}</div>
                        <div id="not-extended">
                            <div class="day-progress-time" id="progressTime">--:--</div>
                            <div class="day-progress-label">remaining</div>
                        </div>
                        <div id="extended">
                            <i>Extended</i>
                        </div>
                    </div>
                </div>
                <button class="extend">Practice</button>
            </div>
        </div>
    </div>

    <!-- Exam Progress Section -->
    <div class="exam-progress">
        <h3 class="section-title"><i class="fas fa-book-open"></i> Exams</h3>
        {% if exams and exams|length > 0 %}
            <div class="exam-cards-grid">
                {% for exam in exams %}
                    <div class="exam-card" onclick="window.location.href='/track/{{ exam._id }}'">
                        <div class="exam-card-header">
                            <h4 class="exam-card-title">{{ exam.name }}</h4>
                            {% if exam.upcoming_date %}
                                <div class="exam-date">
                                    <i class="far fa-calendar-alt"></i> {{ exam.upcoming_date }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <div class="empty-icon"><i class="fas fa-book-open"></i></div>
                <p>No exam data available. Start exploring subjects and chapters to track your progress!</p>
            </div>
        {% endif %}
    </div>

    <!-- Recent Chapters Section -->
    <div class="recent-chapters">
        <h3 class="section-title"><i class="fas fa-brain"></i> Recent Chapters</h3>
        {% if sr_chapters and sr_chapters|length > 0 %}
            <div class="chapters-grid">
                {% for chapter in sr_chapters[:4] %}
                    <div class="chapter-card">
                        <div class="chapter-header">
                            <div class="chapter-title">{{ chapter.title }}</div>
                            <div class="chapter-path">
                                <span class="exam-badge">{{ chapter.exam }}</span>
                                <i class="fas fa-chevron-right"></i>
                                <span class="subject-name">{{ chapter.subject }}</span>
                            </div>
                        </div>
                        
                        <div class="chapter-stats">
                            <div class="stat-row">
                                <div class="stat-item">
                                    <div class="stat-label">Questions Solved</div>
                                    <div class="stat-value">{{ chapter.questions }}</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">Days Since</div>
                                    <div class="stat-value">{{ chapter.days_since }}</div>
                                </div>
                            </div>
                            
                            <div class="ease-progress">
                                <div class="ease-label">
                                    <span>Ease</span>
                                    <span class="ease-value">{{ ((chapter.ef - 1.3) / (2.5 - 1.3) * 100)|round }}%</span>
                                </div>
                                <div class="ease-bar">
                                    <div class="ease-fill" style="width: {{ ((chapter.ef - 1.3) / (2.5 - 1.3) * 100)|round }}%;"></div>
                                </div>
                            </div>
                            <div class="next-practice">
                                {% set days_until_next = chapter.next %}
                                <!-- {% if days_until_next <= 0 %} -->
                                    <div class="practice-status overdue">
                                        <i class="fas fa-exclamation-circle"></i>
                                        <span>Review Overdue</span>
                                    </div>
                                <!-- {% elif days_until_next <= 2 %} -->
                                    <div class="practice-status due-soon">
                                        <i class="fas fa-clock"></i>
                                        <span>Due in {{ days_until_next }} day{{ 's' if days_until_next > 1 else '' }}</span>
                                    </div>
                                <!-- {% else %} -->
                                    <div class="practice-status future">
                                        <i class="fas fa-calendar-check"></i>
                                        <span>Due in {{ days_until_next }} days</span>
                                    </div>
                                <!-- {% endif %} -->
                            </div>
                        </div>
                        
                        <div class="chapter-actions">
                            <button class="practice-chapter-btn" data-chapter="{{ chapter.chapter_id }}" data-exam="{{ chapter.exam }}" data-subject="{{ chapter.subject }}">
                                <i class="fas fa-play"></i>
                                Practice Now
                            </button>
                            <button class="practice-chapter-btn" onclick="window.location.href='/track/chapter/{{ chapter.chapter_id }}'">
                                Review
                            </button>
                        </div>
                    </div>
                {% endfor %}
            </div>
            
            <!-- View More Button -->
            <div class="chapters-view-more">
                <a href="/practice/chapters" class="view-more-chapters-btn">
                    <i class="fas fa-brain"></i> View All Chapters
                </a>
            </div>
        {% else %}
            <div class="empty-state">
                <div class="empty-icon"><i class="fas fa-brain"></i></div>
                <p>No chapter progress data available. Start practicing to see your spaced repetition progress!</p>
            </div>
        {% endif %}
    </div>

    <div class="actions">
        <a href="/search" class="action-btn">
            <i class="fas fa-search"></i>
            <h5 class="action-title">Search 47k+ Questions</h5>
        </a>
        <a href="/test/generate" class="action-btn">
            <i class="fas fa-clipboard-list"></i>
            <h5 class="action-title">Generate Personalized Tests</h5>
        </a>
        <a href="/ai" class="action-btn">
            <i class="fas fa-robot"></i>
            <h5 class="action-title">Ask Doubts to PlanqAI</h5>
        </a>
    </div>

    <div class="activity">
        <h3 class="section-title"><i class="fas fa-chart-line"></i> Recent Activity</h3>
        {% if activity and activity|length > 0 %}
            <!-- Update the activity item section in the main activity list -->
            <div class="activity-list">
                {% for item in activity[:5] %}
                    <div class="activity-item">
                        {% if item.action == "test_created" %}
                            <div class="activity-icon"><i class="fas fa-plus-circle"></i></div>
                        {% elif item.action == "test_completed" %}
                            <div class="activity-icon"><i class="fas fa-check-circle"></i></div>
                        {% elif item.action == "test_started" %}
                            <div class="activity-icon"><i class="fas fa-play-circle"></i></div>
                        {% elif item.action == "attempt_question" %}
                            <div class="activity-icon {% if item.details.is_correct %}correct{% else %}incorrect{% endif %}">
                                {% if item.details.is_correct %}
                                <i class="fas fa-check"></i>
                                {% else %}
                                <i class="fas fa-times"></i>
                                {% endif %}
                            </div>
                        {% elif item.action == "practice_completed" %}
                            <div class="activity-icon {% if item.details.is_success %}correct{% else %}incorrect{% endif %}">
                                {% if item.details.is_success %}
                                <i class="fas fa-fire"></i>
                                {% else %}
                                <i class="fas fa-heart-broken"></i>
                                {% endif %}
                            </div>
                        {% elif item.action == "achievement_unlocked" %}
                            <div class="activity-icon"><i class="fas {{ac[item.details.achievement_id]['icon']}}"></i></div>
                        {% else %}
                            <div class="activity-icon"><i class="fas fa-bell"></i></div>
                        {% endif %}
                        <div class="activity-content">
                            <div class="activity-header">
                                {% if item.action == "test_created" %}
                                    <span>Created a new test: <strong>{{ item.details.title }}</strong></span>
                                {% elif item.action == "test_completed" %}
                                    <div class="activity-header-content">
                                        <span>Completed test: <strong>{{ item.details.title }}</strong></span>
                                        <div class="activity-score">
                                            {{ item.details.score }}
                                        </div>
                                    </div>
                                {% elif item.action == "test_started" %}
                                    <span>Started test: <strong>{{ item.details.title }}</strong></span>
                                {% elif item.action == "attempt_question" %}
                                    Attempted a question 
                                    <div class="{% if item.details.is_correct %}answer-correct{% else %}answer-incorrect{% endif %}">
                                        {% if item.details.is_correct %}
                                            <i class="fas fa-check-circle"></i> Correct
                                        {% else %}
                                            <i class="fas fa-times-circle"></i> Incorrect
                                        {% endif %}
                                    </div>
                                {% elif item.action == "practice_completed" %}
                                    <div class="activity-header-content">
                                        <span>Completed practice session</span>
                                        <div class="practice-session-stats">
                                            {% if item.details.streak_extended %}
                                                <div class="practice-session-badge success">
                                                    <i class="fas fa-fire"></i> Streak Extended
                                                </div>
                                            {% endif %}
                                            
                                            <!-- Health Badge - simplified display -->
                                            <div class="health-badge {% if item.details.health_remaining > 70 %}high{% elif item.details.health_remaining > 30 %}medium{% else %}low{% endif %}">
                                                <i class="fas fa-heart"></i> {{ item.details.health_remaining|round|int }}%
                                            </div>
                                        </div>
                                    </div>
                                
                                {% elif item.action == "practice_started" %}
                                    <div class="activity-header-content">
                                        <span>Started practice session: <strong>{{ item.details.exam }} - {{ item.details.subject }} - {{ item.details.chapter }}</strong></span>
                                        <div class="daily-task-info">
                                            <span class="task-badge">
                                                <i class="fas fa-list-ol"></i> {{ item.details.count }} questions
                                            </span>
                                        </div>
                                    </div>
                                {% elif item.action == "achievement_unlocked" %}
                                <div class="activity-header-content">
                                    <span>Unlocked achievement: <strong>{{ ac[item.details.achievement_id]['name'] }}</strong></span>
                                </div>
                                {% else %}
                                    {{ item.action }}
                                {% endif %}
                            </div>
                            <div class="activity-time">
                                <i class="far fa-clock"></i> {{ item.timestamp|formatdatetime }}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            {% if activity|length > 5 %}
            <div class="view-all-container">
                <button id="view-all-activity" class="view-all-btn">
                    <i class="fas fa-history"></i> View All Activities
                </button>
            </div>
            {% endif %}
        {% else %}
            <div class="empty-state">
                <div class="empty-icon"><i class="fas fa-history"></i></div>
                <p>No recent activity to show. Start solving problems to see your progress here!</p>
            </div>
        {% endif %}
    </div>
    
    <div class="tests">
        <h3 class="section-title"><i class="fas fa-tasks"></i> My Tests</h3>
        {% if tests and tests|length > 0 %}
            <div class="tests-list">
                {% for test in tests[:2] %}
                    <div class="test-item">
                        <div class="test-item-header">
                            <h4 class="test-title">{{ test.title }}</h4>
                            {% if test.mode == "generate" %}
                                <div class="test-badge custom">
                                    <i class="fas fa-magic"></i> Custom
                                </div>
                            {% elif test.mode == "previous" %}
                                <div class="test-badge previous">
                                    <i class="fas fa-history"></i> PYQ
                                </div>
                            {% endif %}
                        </div>
                        <div class="test-item-body">
                            <div class="test-meta">
                                <div class="test-date"><i class="far fa-calendar-alt"></i> {{ test.created_at|formatdate }}</div>
                                <div class="test-duration"><i class="far fa-clock"></i> {{ test.duration }} min</div>
                            </div>
                            {% if test.attempts and test.attempts|length > 0 %}
                                <div class="test-attempts">
                                    <div class="attempt-count">
                                        <i class="fas fa-check-double"></i> {{ test.attempts|length }} attempt{{ 's' if test.attempts|length > 1 else '' }}
                                    </div>
                                    <div class="score-pill {{ 'high-score' if (test.attempts[0].score / test.max_marks * 100) >= 70 
                                                            else 'mid-score' if (test.attempts[0].score / test.max_marks * 100) >= 40 
                                                            else 'low-score' }}">
                                        {{ test.attempts[0].score }}
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                        <div class="test-item-footer">
                            <div class="test-actions">
                                <a href="/test/{{ test._id }}" class="test-action-btn">
                                    {% if test.attempts and test.attempts|length > 0 %}
                                        <i class="fas fa-redo"></i> Retry
                                    {% else %}
                                        <i class="fas fa-play"></i> Start
                                    {% endif %}
                                </a>
                                {% if test.attempts and test.attempts|length > 0 %}
                                <a href="/test/{{ test._id }}/analysis" class="test-action-btn analysis">
                                    <i class="fas fa-chart-bar"></i> Analysis
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            {% if tests|length > 2 %}
            <div class="view-all-container">
                <button id="view-all-tests" class="view-all-btn">
                    <i class="fas fa-clipboard-list"></i> View All Tests
                </button>
            </div>
            {% endif %}
        {% else %}
            <div class="empty-state">
                <div class="empty-icon"><i class="fas fa-clipboard-list"></i></div>
                <p>You haven't created any tests yet. Generate your first personalized test below!</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Tooltip for heatmap -->
<div id="heatmap-tooltip" class="heatmap-tooltip"></div>

<!-- Activity Modal -->
<div id="activity-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-chart-line"></i> All Activities</h3>
            <span class="modal-close">&times;</span>
        </div>
        <div class="modal-body">
            {% if paginated_activity and paginated_activity.activities|length > 0 %}
                <div class="activity-list-full">
                    {% for item in paginated_activity.activities %}
                        <div class="activity-item">
                            {% if item.action == "test_created" %}
                                <div class="activity-icon"><i class="fas fa-plus-circle"></i></div>
                            {% elif item.action == "test_completed" %}
                                <div class="activity-icon"><i class="fas fa-check-circle"></i></div>
                            {% elif item.action == "test_started" %}
                                <div class="activity-icon"><i class="fas fa-play-circle"></i></div>
                            {% elif item.action == "attempt_question" %}
                                <div class="activity-icon {% if item.details.is_correct %}correct{% else %}incorrect{% endif %}">
                                    {% if item.details.is_correct %}
                                    <i class="fas fa-check"></i>
                                    {% else %}
                                    <i class="fas fa-times"></i>
                                    {% endif %}
                                </div>
                            {% elif item.action == "practice_completed" %}
                                <div class="activity-icon {% if item.details.is_success %}correct{% else %}incorrect{% endif %}">
                                    {% if item.details.is_success %}
                                    <i class="fas fa-fire"></i>
                                    {% else %}
                                    <i class="fas fa-heart-broken"></i>
                                    {% endif %}
                                </div>
                            {% elif item.action == "practice_started" %}
                                <div class="activity-icon"><i class="fas fa-play"></i></div>
                            {% elif item.action == "achievement_unlocked" %}
                                <div class="activity-icon"><i class="fas {{ac[item.details.achievement_id]['icon']}}"></i></div>
                            {% else %}
                                <div class="activity-icon"><i class="fas fa-bell"></i></div>
                            {% endif %}
                            <div class="activity-content">
                                <div class="activity-header">
                                    {% if item.action == "test_created" %}
                                        Created a new test:&nbsp; <strong>{{ item.details.title }}</strong>
                                    {% elif item.action == "test_completed" %}
                                        Completed test:&nbsp; <strong>{{ item.details.title }}</strong>
                                        <div class="activity-score">
                                            {{ item.details.score }}
                                        </div>
                                    {% elif item.action == "test_started" %}
                                        Started test:&nbsp; <strong>{{ item.details.title }}</strong>
                                    {% elif item.action == "attempt_question" %}
                                        Attempted a question 
                                        <div class="{% if item.details.is_correct %}answer-correct{% else %}answer-incorrect{% endif %}">
                                            {% if item.details.is_correct %}
                                                <i class="fas fa-check-circle"></i> Correct
                                            {% else %}
                                                <i class="fas fa-times-circle"></i> Incorrect
                                            {% endif %}
                                        </div>
                                    {% elif item.action == "practice_completed" %}
                                    <div class="activity-header-content">
                                        <span>Completed practice session</span>
                                        <div class="practice-session-stats">
                                            {% if item.details.streak_extended %}
                                                <div class="practice-session-badge success">
                                                    <i class="fas fa-fire"></i> Streak Extended
                                                </div>
                                            {% endif %}
                                            
                                            <!-- Health Badge - simplified display -->
                                            <div class="health-badge {% if item.details.health_remaining > 70 %}high{% elif item.details.health_remaining > 30 %}medium{% else %}low{% endif %}">
                                                <i class="fas fa-heart"></i> {{ item.details.health_remaining|round|int }}%
                                            </div>
                                        </div>
                                    </div>
                                    {% elif item.action == "practice_started" %}
                                    <div class="activity-header-content">
                                        <span>Started practice session: <strong>{{ item.details.exam }} - {{ item.details.subject }} - {{ item.details.chapter }}</strong></span>
                                        <div class="daily-task-info">
                                            <span class="task-badge">
                                                <i class="fas fa-list-ol"></i> {{ item.details.count }} questions
                                            </span>
                                        </div>
                                    </div>
                                    {% elif item.action == "achievement_unlocked" %}
                                    <div class="activity-header-content">
                                        <span>Unlocked achievement: <strong>{{ ac[item.details.achievement_id]['name'] }}</strong></span>
                                    </div>
                                    {% else %}
                                        {{ item.action }}
                                    {% endif %}
                                </div>
                                <div class="activity-time">
                                    <i class="far fa-clock"></i> {{ item.timestamp|formatdatetime }}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                
                <!-- Add pagination controls -->
                <div class="pagination-container">
                    <div class="pagination-info">
                        Showing {{ (paginated_activity.page - 1) * paginated_activity.per_page + 1 }} 
                        to {{ [paginated_activity.page * paginated_activity.per_page, paginated_activity.total]|min }} 
                        of {{ paginated_activity.total }} activities
                    </div>
                    <div class="pagination-controls">
                        {% if paginated_activity.page > 1 %}
                            <button class="pagination-btn" data-page="1">
                                <i class="fas fa-angle-double-left"></i>
                            </button>
                            <button class="pagination-btn" data-page="{{ paginated_activity.page - 1 }}">
                                <i class="fas fa-angle-left"></i>
                            </button>
                        {% else %}
                            <button class="pagination-btn disabled">
                                <i class="fas fa-angle-double-left"></i>
                            </button>
                            <button class="pagination-btn disabled">
                                <i class="fas fa-angle-left"></i>
                            </button>
                        {% endif %}
                        
                        <!-- Page number buttons -->
                        {% set start = [paginated_activity.page - 2, 1]|max %}
                        {% set end = [start + 4, paginated_activity.total_pages + 1]|min %}
                        {% set start = [end - 5, 1]|max %}
                        
                        {% for p in range(start, end) %}
                            <button class="pagination-btn {% if p == paginated_activity.page %}active{% endif %}" 
                                    data-page="{{ p }}">{{ p }}</button>
                        {% endfor %}
                        
                        {% if paginated_activity.page < paginated_activity.total_pages %}
                            <button class="pagination-btn" data-page="{{ paginated_activity.page + 1 }}">
                                <i class="fas fa-angle-right"></i>
                            </button>
                            <button class="pagination-btn" data-page="{{ paginated_activity.total_pages }}">
                                <i class="fas fa-angle-double-right"></i>
                            </button>
                        {% else %}
                            <button class="pagination-btn disabled">
                                <i class="fas fa-angle-right"></i>
                            </button>
                            <button class="pagination-btn disabled">
                                <i class="fas fa-angle-double-right"></i>
                            </button>
                        {% endif %}
                    </div>
                </div>
            {% else %}
                <div class="empty-state">
                    <p>No activity to show.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Tests Modal -->
<div id="tests-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-tasks"></i> All Tests</h3>
            <span class="modal-close">&times;</span>
        </div>
        <div class="modal-body">
            {% if tests and tests|length > 0 %}
                <div class="tests-grid-full">
                    {% for test in tests %}
                        <div class="test-item">
                            <div class="test-item-header">
                                <h4 class="test-title">{{ test.title }}</h4>
                                {% if test.mode == "generate" %}
                                    <div class="test-badge custom">
                                        <i class="fas fa-magic"></i> Custom
                                    </div>
                                {% elif test.mode == "previous" %}
                                    <div class="test-badge previous">
                                        <i class="fas fa-history"></i> PYQ
                                    </div>
                                {% endif %}
                            </div>
                            <div class="test-item-body">
                                <div class="test-meta">
                                    <div class="test-date"><i class="far fa-calendar-alt"></i> {{ test.created_at|formatdate }}</div>
                                    <div class="test-duration"><i class="far fa-clock"></i> {{ test.duration }} min</div>
                                </div>
                                {% if test.attempts and test.attempts|length > 0 %}
                                    <div class="test-attempts">
                                        <div class="attempt-count">
                                            <i class="fas fa-check-double"></i> {{ test.attempts|length }} attempt{{ 's' if test.attempts|length > 1 else '' }}
                                        </div>
                                        <div class="score-pill {{ 'high-score' if (test.attempts[0].score / test.max_marks * 100) >= 70 
                                                                else 'mid-score' if (test.attempts[0].score / test.max_marks * 100) >= 40 
                                                                else 'low-score' }}">
                                            {{ test.attempts[0].score }}
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="test-no-attempts">
                                        <i class="far fa-hourglass"></i> Not attempted yet
                                    </div>
                                {% endif %}
                            </div>
                            <div class="test-item-footer">
                                <div class="test-actions">
                                    <a href="/test/{{ test._id }}" class="test-action-btn">
                                        {% if test.attempts and test.attempts|length > 0 %}
                                            <i class="fas fa-redo"></i> Retry
                                        {% else %}
                                            <i class="fas fa-play"></i> Start
                                        {% endif %}
                                    </a>
                                    <a href="/test/{{ test._id }}/analysis" class="test-action-btn analysis {{ 'disabled' if not test.attempts or test.attempts|length == 0 }}">
                                        <i class="fas fa-chart-bar"></i> Analysis
                                    </a>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <p>You haven't created any tests yet.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add this modal after your existing modals -->
<div id="extend-streak-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-calendar-plus"></i> Daily Task</h3>
            <span class="modal-close">&times;</span>
        </div>
        <div class="modal-body">
            <div class="daily-task-form">
                <div class="filter-section">
                    <div class="filters-container">
                        <div class="filter-group">
                            <label>Exam:</label>
                            <select id="examFilter" class="form-select">
                                <option value="">Select Exam</option>
                                {% for exam in exams %}
                                <option value="{{ exam._id }}">{{ exam.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>Subject:</label>
                            <select id="subjectFilter" class="form-select" disabled>
                                <option value="">Select Subject</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>Chapter:</label>
                            <select id="chapterFilter" class="form-select" disabled>
                                <option value="">Select Chapter</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="daily-task-options">
                    <div class="option-group">
                        <label>Questions:</label>
                        <div class="number-input">
                            <button type="button" onclick="decrementQuestions()">-</button>
                            <input type="number" min="5" max="30" value="5" id="questionCount">
                            <button type="button" onclick="incrementQuestions()">+</button>
                        </div>
                    </div>
                    
                    <div class="option-group">
                        <label>Time (minutes):</label>
                        <div class="number-input">
                            <button type="button" onclick="decrementTime()">-</button>
                            <input type="number" min="5" max="120" value="30" id="timeLimit">
                            <button type="button" onclick="incrementTime()">+</button>
                        </div>
                    </div>
                </div>
                
                <!-- Add threshold warning message -->
                <div id="thresholdWarning" class="threshold-warning" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Warning message will appear here</span>
                </div>

                <div class="form-actions">
                    <button id="startDailyTask" class="btn btn-primary">Start</button>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    function decrementQuestions() {
        const input = document.getElementById('questionCount');
        const currentValue = parseInt(input.value);
        const minValue = parseInt(input.min);
        if (currentValue > minValue) {
            input.value = currentValue - 1;
            checkQuestionThreshold();
        }
    }

    function incrementQuestions() {
        const input = document.getElementById('questionCount');
        const currentValue = parseInt(input.value);
        const maxValue = parseInt(input.max);
        if (currentValue < maxValue) {
            input.value = currentValue + 1;
            checkQuestionThreshold();
        }
    }

    function decrementTime() {
        const input = document.getElementById('timeLimit');
        const currentValue = parseInt(input.value);
        const minValue = parseInt(input.min);
        if (currentValue > minValue) {
            input.value = currentValue - 1;
        }
    }

    function incrementTime() {
        const input = document.getElementById('timeLimit');
        const currentValue = parseInt(input.value);
        const maxValue = parseInt(input.max);
        if (currentValue < maxValue) {
            input.value = currentValue + 1;
        }
    }
</script>
<script src="/static/js/dashboard.js"></script>
{% endblock %}