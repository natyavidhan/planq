{% extends 'base.html' %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<link rel="stylesheet" href="/static/dashboard.css">
<div class="home">
    <div class="title-bar">
        <h2>Welcome, {{user['username']}} <span class="badge">Pro</span></h2>
    </div>
    
    <!-- Activity Heatmap -->
    <div class="heatmap-container">

        
        <div class="heatmap-wrapper">
            <div class="heatmap-container-inner">
                <!-- Month labels -->
                <div class="heatmap-months">
                    {% for month in heatmap_data.months %}
                    <div class="month-label">{{ month.name }}</div>
                    {% endfor %}
                </div>
                
                <!-- Heatmap grid -->
                <div class="heatmap-grid">
                    <!-- Day labels column -->
                    <div class="heatmap-days-column">
                        <div class="day-label">Mon</div>
                        <div class="day-label">Tue</div>
                        <div class="day-label">Wed</div>
                        <div class="day-label">Thu</div>
                        <div class="day-label">Fri</div>
                        <div class="day-label">Sat</div>
                        <div class="day-label">Sun</div>
                    </div>
                    
                    <!-- Activity weeks -->
                    <div class="heatmap-weeks">
                        {% for week in heatmap_data.weeks %}
                        <div class="heatmap-week">
                            {% for day in week %}
                            <div class="heatmap-day level-{{ day.level }}" 
                                 data-date="{{ day.date }}" 
                                 data-count="{{ day.count }}">
                            </div>
                            {% endfor %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Legend -->
                <div class="heatmap-legend">
                    <span class="legend-text">Less</span>
                    <div class="legend-squares">
                        <div class="legend-item level-0" title="No activity"></div>
                        <div class="legend-item level-1" title="1-2 activities"></div>
                        <div class="legend-item level-2" title="3-5 activities"></div>
                        <div class="legend-item level-3" title="6-10 activities"></div>
                        <div class="legend-item level-4" title="11+ activities"></div>
                    </div>
                    <span class="legend-text">More</span>
                </div>
            </div>
        </div>

        <div class="heatmap-header">
            <div class="day-progress-container">
                <div class="day-progress-circle" id="dayProgress">
                    <div class="day-progress-inner">
                        <div class="streak-number">{{ heatmap_data.current_streak or 0 }}</div>
                        <div id="not-extended">
                            <div class="day-progress-time" id="progressTime">--:--</div>
                            <div class="day-progress-label">remaining</div>
                        </div>
                        <div id="extended">
                            <i>Extended</i>
                        </div>
                    </div>
                </div>
                <button class="extend">Extend</button>
            </div>
        </div>
    </div>

    <div class="activity">
        <h3 class="section-title"><i class="fas fa-chart-line"></i> Recent Activity</h3>
        {% if activity and activity|length > 0 %}
            <div class="activity-list">
                {% for item in activity[:5] %}
                    <div class="activity-item">
                        {% if item.action == "test_created" %}
                            <div class="activity-icon"><i class="fas fa-plus-circle"></i></div>
                        {% elif item.action == "test_completed" %}
                            <div class="activity-icon"><i class="fas fa-check-circle"></i></div>
                        {% elif item.action == "test_started" %}
                            <div class="activity-icon"><i class="fas fa-play-circle"></i></div>
                        {% elif item.action == "attempt_question" %}
                            <div class="activity-icon {% if item.details.is_correct %}correct{% else %}incorrect{% endif %}">
                                {% if item.details.is_correct %}
                                <i class="fas fa-check"></i>
                                {% else %}
                                <i class="fas fa-times"></i>
                                {% endif %}
                            </div>
                        {% else %}
                            <div class="activity-icon"><i class="fas fa-bell"></i></div>
                        {% endif %}
                        <div class="activity-content">
                            <div class="activity-header">
                                {% if item.action == "test_created" %}
                                    <span>Created a new test: <strong>{{ item.details.title }}</strong></span>
                                {% elif item.action == "test_completed" %}
                                    <div class="activity-header-content">
                                        <span>Completed test: <strong>{{ item.details.title }}</strong></span>
                                        <div class="activity-score">
                                            <i class="fas fa-star"></i> {{ item.details.score }}
                                        </div>
                                    </div>
                                {% elif item.action == "test_started" %}
                                    <span>Started test: <strong>{{ item.details.title }}</strong></span>
                                {% elif item.action == "attempt_question" %}
                                    Attempted a question 
                                    <div class="{% if item.details.is_correct %}answer-correct{% else %}answer-incorrect{% endif %}">
                                        {% if item.details.is_correct %}
                                            <i class="fas fa-check-circle"></i> Correct
                                        {% else %}
                                            <i class="fas fa-times-circle"></i> Incorrect
                                        {% endif %}
                                    </div>
                                {% else %}
                                    {{ item.action }}
                                {% endif %}
                            </div>
                            <div class="activity-time">
                                <i class="far fa-clock"></i> {{ item.timestamp|formatdatetime }}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            {% if activity|length > 5 %}
            <div class="view-all-container">
                <button id="view-all-activity" class="view-all-btn">
                    <i class="fas fa-history"></i> View All Activities
                </button>
            </div>
            {% endif %}
        {% else %}
            <div class="empty-state">
                <div class="empty-icon"><i class="fas fa-history"></i></div>
                <p>No recent activity to show. Start solving problems to see your progress here!</p>
            </div>
        {% endif %}
    </div>
    
    <div class="tests">
        <h3 class="section-title"><i class="fas fa-tasks"></i> My Tests</h3>
        {% if tests and tests|length > 0 %}
            <div class="tests-list">
                {% for test in tests[:2] %}
                    <div class="test-item">
                        <div class="test-item-header">
                            <h4 class="test-title">{{ test.title }}</h4>
                            {% if test.mode == "generate" %}
                                <div class="test-badge custom">
                                    <i class="fas fa-magic"></i> Custom
                                </div>
                            {% elif test.mode == "previous" %}
                                <div class="test-badge previous">
                                    <i class="fas fa-history"></i> PYQ
                                </div>
                            {% endif %}
                        </div>
                        <div class="test-item-body">
                            <div class="test-meta">
                                <div class="test-date"><i class="far fa-calendar-alt"></i> {{ test.created_at|formatdate }}</div>
                                <div class="test-duration"><i class="far fa-clock"></i> {{ test.duration }} min</div>
                            </div>
                            {% if test.attempts and test.attempts|length > 0 %}
                                <div class="test-attempts">
                                    <div class="attempt-count">
                                        <i class="fas fa-check-double"></i> {{ test.attempts|length }} attempt{{ 's' if test.attempts|length > 1 else '' }}
                                    </div>
                                    <div class="score-pill {{ 'high-score' if (test.attempts[0].score / test.max_marks * 100) >= 70 
                                                            else 'mid-score' if (test.attempts[0].score / test.max_marks * 100) >= 40 
                                                            else 'low-score' }}">
                                        {{ test.attempts[0].score }}
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                        <div class="test-item-footer">
                            <div class="test-actions">
                                <a href="/test/{{ test._id }}" class="test-action-btn">
                                    {% if test.attempts and test.attempts|length > 0 %}
                                        <i class="fas fa-redo"></i> Retry
                                    {% else %}
                                        <i class="fas fa-play"></i> Start
                                    {% endif %}
                                </a>
                                {% if test.attempts and test.attempts|length > 0 %}
                                <a href="/test/{{ test._id }}/analysis" class="test-action-btn analysis">
                                    <i class="fas fa-chart-bar"></i> Analysis
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            {% if tests|length > 2 %}
            <div class="view-all-container">
                <button id="view-all-tests" class="view-all-btn">
                    <i class="fas fa-clipboard-list"></i> View All Tests
                </button>
            </div>
            {% endif %}
        {% else %}
            <div class="empty-state">
                <div class="empty-icon"><i class="fas fa-clipboard-list"></i></div>
                <p>You haven't created any tests yet. Generate your first personalized test below!</p>
            </div>
        {% endif %}
    </div>
    
    <div class="actions">
        <a href="/search" class="action-btn">
            <i class="fas fa-search"></i>
            <h5 class="action-title">Search 47k+ Questions</h5>
        </a>
        <a href="/test/generate" class="action-btn">
            <i class="fas fa-clipboard-list"></i>
            <h5 class="action-title">Generate Personalized Tests</h5>
        </a>
        <a href="/ai" class="action-btn">
            <i class="fas fa-robot"></i>
            <h5 class="action-title">Ask Doubts to PlanqAI</h5>
        </a>
    </div>
</div>

<!-- Tooltip for heatmap -->
<div id="heatmap-tooltip" class="heatmap-tooltip"></div>

<!-- Activity Modal -->
<div id="activity-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-chart-line"></i> All Activities</h3>
            <span class="modal-close">&times;</span>
        </div>
        <div class="modal-body">
            {% if activity and activity|length > 0 %}
                <div class="activity-list-full">
                    {% for item in activity %}
                        <div class="activity-item">
                            {% if item.action == "test_created" %}
                                <div class="activity-icon"><i class="fas fa-plus-circle"></i></div>
                            {% elif item.action == "test_completed" %}
                                <div class="activity-icon"><i class="fas fa-check-circle"></i></div>
                            {% elif item.action == "test_started" %}
                                <div class="activity-icon"><i class="fas fa-play-circle"></i></div>
                            {% elif item.action == "attempt_question" %}
                                <div class="activity-icon {% if item.details.is_correct %}correct{% else %}incorrect{% endif %}">
                                    {% if item.details.is_correct %}
                                    <i class="fas fa-check"></i>
                                    {% else %}
                                    <i class="fas fa-times"></i>
                                    {% endif %}
                                </div>
                            {% else %}
                                <div class="activity-icon"><i class="fas fa-bell"></i></div>
                            {% endif %}
                            <div class="activity-content">
                                <div class="activity-header">
                                    {% if item.action == "test_created" %}
                                        Created a new test:&nbsp; <strong>{{ item.details.title }}</strong>
                                    {% elif item.action == "test_completed" %}
                                        Completed test:&nbsp; <strong>{{ item.details.title }}</strong>
                                        <div class="activity-score">
                                            <i class="fas fa-star"></i> {{ item.details.score }}
                                        </div>
                                    {% elif item.action == "test_started" %}
                                        Started test:&nbsp; <strong>{{ item.details.title }}</strong>
                                    {% elif item.action == "attempt_question" %}
                                        Attempted a question 
                                        <div class="{% if item.details.is_correct %}answer-correct{% else %}answer-incorrect{% endif %}">
                                            {% if item.details.is_correct %}
                                                <i class="fas fa-check-circle"></i> Correct
                                            {% else %}
                                                <i class="fas fa-times-circle"></i> Incorrect
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        {{ item.action }}
                                    {% endif %}
                                </div>
                                <div class="activity-time">
                                    <i class="far fa-clock"></i> {{ item.timestamp|formatdatetime }}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <p>No activity to show.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Tests Modal -->
<div id="tests-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-tasks"></i> All Tests</h3>
            <span class="modal-close">&times;</span>
        </div>
        <div class="modal-body">
            {% if tests and tests|length > 0 %}
                <div class="tests-grid-full">
                    {% for test in tests %}
                        <div class="test-item">
                            <div class="test-item-header">
                                <h4 class="test-title">{{ test.title }}</h4>
                                {% if test.mode == "generate" %}
                                    <div class="test-badge custom">
                                        <i class="fas fa-magic"></i> Custom
                                    </div>
                                {% elif test.mode == "previous" %}
                                    <div class="test-badge previous">
                                        <i class="fas fa-history"></i> PYQ
                                    </div>
                                {% endif %}
                            </div>
                            <div class="test-item-body">
                                <div class="test-meta">
                                    <div class="test-date"><i class="far fa-calendar-alt"></i> {{ test.created_at|formatdate }}</div>
                                    <div class="test-duration"><i class="far fa-clock"></i> {{ test.duration }} min</div>
                                </div>
                                {% if test.attempts and test.attempts|length > 0 %}
                                    <div class="test-attempts">
                                        <div class="attempt-count">
                                            <i class="fas fa-check-double"></i> {{ test.attempts|length }} attempt{{ 's' if test.attempts|length > 1 else '' }}
                                        </div>
                                        <div class="score-pill {{ 'high-score' if (test.attempts[0].score / test.max_marks * 100) >= 70 
                                                                else 'mid-score' if (test.attempts[0].score / test.max_marks * 100) >= 40 
                                                                else 'low-score' }}">
                                            {{ test.attempts[0].score }}
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="test-no-attempts">
                                        <i class="far fa-hourglass"></i> Not attempted yet
                                    </div>
                                {% endif %}
                            </div>
                            <div class="test-item-footer">
                                <div class="test-actions">
                                    <a href="/test/{{ test._id }}" class="test-action-btn">
                                        {% if test.attempts and test.attempts|length > 0 %}
                                            <i class="fas fa-redo"></i> Retry
                                        {% else %}
                                            <i class="fas fa-play"></i> Start
                                        {% endif %}
                                    </a>
                                    <a href="/test/{{ test._id }}/analysis" class="test-action-btn analysis {{ 'disabled' if not test.attempts or test.attempts|length == 0 }}">
                                        <i class="fas fa-chart-bar"></i> Analysis
                                    </a>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <p>You haven't created any tests yet.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    // Day progress and heatmap functionality
    document.addEventListener('DOMContentLoaded', function() {
        
        // Destroy all heatmap days after today
        const today = new Date();
        today.setHours(0,0,0,0);

        document.querySelectorAll('.heatmap-day').forEach(day => {
            const dateStr = day.getAttribute('data-date');
            if (dateStr) {
                const cellDate = new Date(dateStr);
                cellDate.setHours(0,0,0,0);
                if (cellDate > today) {
                    day.style.display = 'none'; // or: day.remove();
                }
            }
        });
        // Day progress circle
        function updateDayProgress() {
            const now = new Date();
            const endOfDay = new Date();
            endOfDay.setHours(23, 59, 59, 999);
            
            const totalMs = 24 * 60 * 60 * 1000; // Total milliseconds in a day
            const elapsedMs = now.getTime() - new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            const remainingMs = totalMs - elapsedMs;
            
            // Calculate progress percentage (0-100)
            const progressPercent = (elapsedMs / totalMs) * 100;
            const progressAngle = (progressPercent / 100) * 360;
            
            // Calculate remaining time
            const remainingHours = Math.floor(remainingMs / (1000 * 60 * 60));
            const remainingMinutes = Math.floor((remainingMs % (1000 * 60 * 60)) / (1000 * 60));
            
            // Update the circle
            const circle = document.getElementById('dayProgress');
            const timeDisplay = document.getElementById('progressTime');
            
            if (circle && timeDisplay) {
                circle.style.setProperty('--progress-angle', progressAngle + 'deg');
                timeDisplay.textContent = `${remainingHours.toString().padStart(2, '0')}:${remainingMinutes.toString().padStart(2, '0')}`;
            }
        }
        
        // Update immediately and then every minute
        updateDayProgress();
        setInterval(updateDayProgress, 60000);
        
        // Heatmap tooltip functionality
        const tooltip = document.getElementById('heatmap-tooltip');
        const heatmapDays = document.querySelectorAll('.heatmap-day');
        
        heatmapDays.forEach(day => {
            day.addEventListener('mouseenter', function(e) {
                const date = this.getAttribute('data-date');
                const count = parseInt(this.getAttribute('data-count'));
                const formattedDate = new Date(date).toLocaleDateString('en-US', {
                    weekday: 'long',
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
                
                let activityText;
                if (count === 0) {
                    activityText = 'No activities';
                } else if (count === 1) {
                    activityText = '1 activity';
                } else {
                    activityText = `${count} activities`;
                }
                
                tooltip.innerHTML = `<strong>${activityText}</strong><br>${formattedDate}`;
                tooltip.style.display = 'block';
                
                // Position tooltip above the hovered day
                const rect = this.getBoundingClientRect();
                const tooltipRect = tooltip.getBoundingClientRect();
                
                let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
                let top = rect.top - tooltipRect.height - 12;
                
                // Keep tooltip within viewport bounds
                const padding = 10;
                if (left < padding) {
                    left = padding;
                } else if (left + tooltipRect.width > window.innerWidth - padding) {
                    left = window.innerWidth - tooltipRect.width - padding;
                }
                
                if (top < padding) {
                    top = rect.bottom + 12;
                }
                
                tooltip.style.left = left + window.scrollX + 'px';
                tooltip.style.top = top + window.scrollY + 'px';
            });
            
            day.addEventListener('mouseleave', function() {
                tooltip.style.display = 'none';
            });
        });
        
        // Modal functionality
        const activityModal = document.getElementById('activity-modal');
        const testsModal = document.getElementById('tests-modal');
        
        // Activity modal
        const viewAllActivityBtn = document.getElementById('view-all-activity');
        if (viewAllActivityBtn) {
            viewAllActivityBtn.addEventListener('click', function() {
                activityModal.style.display = 'block';
            });
        }
        
        // Tests modal
        const viewAllTestsBtn = document.getElementById('view-all-tests');
        if (viewAllTestsBtn) {
            viewAllTestsBtn.addEventListener('click', function() {
                testsModal.style.display = 'block';
            });
        }
        
        // Close buttons
        const closeButtons = document.querySelectorAll('.modal-close');
        closeButtons.forEach(function(btn) {
            btn.addEventListener('click', function() {
                activityModal.style.display = 'none';
                testsModal.style.display = 'none';
            });
        });
        
        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target === activityModal) {
                activityModal.style.display = 'none';
            }
            if (event.target === testsModal) {
                testsModal.style.display = 'none';
            }
        });
        function isTodayExtended() {
            const today = new Date();
            today.setHours(0,0,0,0);
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const todayStr = `${yyyy}-${mm}-${dd}`;

            // Find the heatmap-day for today
            const todayCell = document.querySelector(`.heatmap-day[data-date="${todayStr}"]`);
            if (todayCell) {
                const count = parseInt(todayCell.getAttribute('data-count'), 10);
                return count > 0;
            }
            return false;
        }

        // Toggle display based on streak extension
        const extendedDiv = document.getElementById('extended');
        const notExtendedDiv = document.getElementById('not-extended');
        const extendButton = document.querySelector('.extend');
        if (isTodayExtended()) {
            if (extendedDiv) extendedDiv.style.display = '';
            if (notExtendedDiv) notExtendedDiv.style.display = 'none';
            extendButton.style.display = 'none'; // Hide extend button if today is extended
        } else {
            if (extendedDiv) extendedDiv.style.display = 'none';
            if (notExtendedDiv) notExtendedDiv.style.display = '';
            extendButton.style.display = ''; // Show extend button if today is not extended
        }
    });

</script>
{% endblock %}